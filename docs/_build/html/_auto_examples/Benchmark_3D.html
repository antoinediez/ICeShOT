<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Benchmark: 3D Run-and-Tumble with deformations. &mdash; iceshot  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css?v=7f9a90b1" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=61a4c737" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Chemotaxis induced by deformations" href="ChemoDeformation.html" />
    <link rel="prev" title="Active Brownian Particles" href="ActiveBrownian.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            iceshot
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../_auto_tutorials/index.html">Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Gallery</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Examples</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ActiveBrownian.html">Active Brownian Particles</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Benchmark: 3D Run-and-Tumble with deformations.</a></li>
<li class="toctree-l2"><a class="reference internal" href="ChemoDeformation.html">Chemotaxis induced by deformations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Engulfment.html">Engulfment due to surface tension effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Evacuation.html">Crowd evacuation</a></li>
<li class="toctree-l2"><a class="reference internal" href="FallingSpheres.html">Falling soft spheres in 2D</a></li>
<li class="toctree-l2"><a class="reference internal" href="FallingStuff.html">Falling soft spheres in a 3D hourglass domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="Micropipette.html">Micropipette experiment</a></li>
<li class="toctree-l2"><a class="reference internal" href="Protrusions.html">Random protrusions</a></li>
<li class="toctree-l2"><a class="reference internal" href="RodShape.html">Emergence of alignment in a system of active rod-shaped particles</a></li>
<li class="toctree-l2"><a class="reference internal" href="RunTumble3D.html">Run-and-tumble in 3D with soft spheres</a></li>
<li class="toctree-l2"><a class="reference internal" href="RunTumbleDisk.html">Run-and-tumble in 2D with soft spheres in a disk domain</a></li>
<li class="toctree-l2"><a class="reference internal" href="SurfaceTension.html">Sorting due to surface tension effects</a></li>
<li class="toctree-l2"><a class="reference internal" href="TissueGrowth.html">Growth of a 2D cell aggregate</a></li>
<li class="toctree-l2"><a class="reference internal" href="TissueGrowth_3D.html">Growth of a 3D cell aggregate</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/cells.html">Cells</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/costs.html">Costs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/OT.html">Optimal Transport</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">iceshot</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Examples</a></li>
      <li class="breadcrumb-item active">Benchmark: 3D Run-and-Tumble with deformations.</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/_auto_examples/Benchmark_3D.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-auto-examples-benchmark-3d-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="benchmark-3d-run-and-tumble-with-deformations">
<span id="sphx-glr-auto-examples-benchmark-3d-py"></span><h1>Benchmark: 3D Run-and-Tumble with deformations.<a class="headerlink" href="#benchmark-3d-run-and-tumble-with-deformations" title="Link to this heading">ÔÉÅ</a></h1>
<p>As a benchmark, we consider a 3D system of self-propelled deformable ellipsoids in a strongly packed domain. Each particle moves in the direction of its principal axis which evolves according to a re-orientation process subject to the deformations caused by the surrounding particles.
We consider <span class="math notranslate nohighlight">\(N\)</span> particles in a 3D bounded box, discretized on a grid of size <span class="math notranslate nohighlight">\(M^3\)</span>.</p>
<p>Example with <span class="math notranslate nohighlight">\(M=512\)</span> and <span class="math notranslate nohighlight">\(N=1000\)</span></p>
<video autoplay="True" controls="True" loop="True" muted="True" preload="auto" width="400"><source src="../_images/Benchmark_3D.mp4" type="video/mp4"></video><div class="line-block">
<div class="line"><br /></div>
</div>
<p>Using a Nvidia RTX A6000 GPU card, we obtain the following benchmarks (we have excluded the cases where the total number of grid cells to fill the volume of the smallest particle is below 100)</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>M=64</p></th>
<th class="head"><p>M=128</p></th>
<th class="head"><p>M=256</p></th>
<th class="head"><p>M=512</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>N=10</p></td>
<td><p>30 s</p></td>
<td><p>1.3 min</p></td>
<td><p>7.4 min</p></td>
<td><p>62 min</p></td>
</tr>
<tr class="row-odd"><td><p>N=100</p></td>
<td><p>45 s</p></td>
<td><p>1 min</p></td>
<td><p>4.7 min</p></td>
<td><p>36 min</p></td>
</tr>
<tr class="row-even"><td><p>N=1000</p></td>
<td><p>NR</p></td>
<td><p>4 min</p></td>
<td><p>25 min</p></td>
<td><p>3 h</p></td>
</tr>
<tr class="row-odd"><td><p>N=10000</p></td>
<td><p>NR</p></td>
<td><p>NR</p></td>
<td><p>4.9 h</p></td>
<td><p>35 h</p></td>
</tr>
</tbody>
</table>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sphinx_gallery_thumbnail_path = &#39;_static/final_1000_512.png&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;..&quot;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">cells</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">costs</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">OT</span>
<span class="kn">from</span> <span class="nn">iceshot.OT</span> <span class="kn">import</span> <span class="n">OT_solver</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">plot_cells</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">sample</span>
<span class="kn">from</span> <span class="nn">iceshot</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tif</span>
<span class="kn">import</span> <span class="nn">pyvista</span> <span class="k">as</span> <span class="nn">pv</span>
<span class="kn">from</span> <span class="nn">pyvista</span> <span class="kn">import</span> <span class="n">themes</span>

<span class="n">use_cuda</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span>
<span class="k">if</span> <span class="n">use_cuda</span><span class="p">:</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">set_default_tensor_type</span><span class="p">(</span><span class="s2">&quot;torch.cuda.FloatTensor&quot;</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>

<span class="n">ot_algo</span> <span class="o">=</span> <span class="n">OT</span><span class="o">.</span><span class="n">LBFGSB</span>

<span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">plot_every</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">bsr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">simu_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;simu_Benchmark_3D_</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">M</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">simu_name</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">simu_name</span><span class="o">+</span><span class="s2">&quot;/frames&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">simu_name</span><span class="o">+</span><span class="s2">&quot;/data&quot;</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="mi">3</span>

    <span class="n">seeds</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">sample_grid</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="n">d</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">seeds</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">vol_x</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">+</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">vol_x</span> <span class="o">*=</span> <span class="mf">0.8</span><span class="o">/</span><span class="n">vol_x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="n">simu</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">Cells</span><span class="p">(</span>
    <span class="n">seeds</span><span class="o">=</span><span class="n">seeds</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
    <span class="n">vol_x</span><span class="o">=</span><span class="n">vol_x</span><span class="p">,</span><span class="n">extra_space</span><span class="o">=</span><span class="s2">&quot;void&quot;</span><span class="p">,</span><span class="n">ar</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
    <span class="n">bc</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">simu</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">simu</span><span class="o">.</span><span class="n">orientation_from_axis</span><span class="p">()</span>

    <span class="n">min_ar</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">max_ar</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">min_ar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">min_ar</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">simu</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">simu</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
    <span class="n">max_ar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">max_ar</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">simu</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="n">simu</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>


    <span class="n">cost_params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;p&quot;</span> <span class="p">:</span> <span class="n">p</span><span class="p">,</span>
    <span class="s2">&quot;scaling&quot;</span> <span class="p">:</span> <span class="s2">&quot;volume&quot;</span><span class="p">,</span>
    <span class="s2">&quot;C&quot;</span> <span class="p">:</span> <span class="n">eng</span>
    <span class="p">}</span>

    <span class="n">solver</span> <span class="o">=</span> <span class="n">OT_solver</span><span class="p">(</span>
    <span class="n">n_sinkhorn</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">n_sinkhorn_last</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span><span class="n">n_lloyds</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">s0</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
    <span class="n">cost_function</span><span class="o">=</span><span class="n">costs</span><span class="o">.</span><span class="n">anisotropic_power_cost</span><span class="p">,</span><span class="n">cost_params</span><span class="o">=</span><span class="n">cost_params</span>
    <span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">t_iter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">t_plot</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">v0</span> <span class="o">=</span> <span class="mf">0.3</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pos&quot;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;axis&quot;</span> <span class="p">:</span> <span class="p">[],</span>
        <span class="s2">&quot;ar&quot;</span> <span class="p">:</span> <span class="p">[]}</span>

    <span class="c1">#==================== Plot config ======================#</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">global_theme</span><span class="o">.</span><span class="n">volume_mapper</span> <span class="o">=</span> <span class="s1">&#39;fixed_point&#39;</span>
    <span class="n">pv</span><span class="o">.</span><span class="n">global_theme</span><span class="o">.</span><span class="n">render_lines_as_tubes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">cmap0</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">hsv</span>

    <span class="n">off_screen</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">plotter</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Plotter</span><span class="p">(</span><span class="n">lighting</span><span class="o">=</span><span class="s1">&#39;three lights&#39;</span><span class="p">,</span> <span class="n">off_screen</span><span class="o">=</span><span class="n">off_screen</span><span class="p">,</span> <span class="n">image_scale</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">newcolors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
        <span class="c1"># newcolors[n+1,:3] = 0.1 + 0.8*np.random.rand(3)</span>
        <span class="n">newcolors</span><span class="p">[</span><span class="n">n</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cmap0</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">N</span><span class="p">))</span>
        <span class="n">newcolors</span><span class="p">[</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">newcolors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">plot_cells</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">img</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span><span class="n">constant_values</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">add_volume</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span><span class="n">opacity</span><span class="o">=</span><span class="s1">&#39;foreground&#39;</span><span class="p">,</span><span class="n">clim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">diffuse</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">box</span> <span class="o">=</span> <span class="n">pv</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span><span class="n">center</span><span class="o">=</span><span class="p">(</span><span class="n">M</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">M</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">M</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">x_length</span><span class="o">=</span><span class="n">M</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">y_length</span><span class="o">=</span><span class="n">M</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">z_length</span><span class="o">=</span><span class="n">M</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1">#======================================================#</span>

    <span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">simu</span><span class="p">,</span>
                <span class="n">sinkhorn_algo</span><span class="o">=</span><span class="n">OT</span><span class="o">.</span><span class="n">LBFGSB</span><span class="p">,</span><span class="n">cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">tau</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">to_bary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">default_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">bsr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="n">plot_cells</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;wireframe&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">remove_scalar_bar</span><span class="p">()</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="n">simu_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/frames/t_</span><span class="si">{</span><span class="n">t_plot</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
    <span class="n">plotter</span><span class="o">.</span><span class="n">clear_actors</span><span class="p">()</span>

    <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
    <span class="n">t_iter</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">t_plot</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">solver</span><span class="o">.</span><span class="n">n_lloyds</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1">#======================================================#</span>

    <span class="k">while</span> <span class="n">t</span><span class="o">&lt;</span><span class="n">T</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plotting_time</span> <span class="o">=</span> <span class="n">t_iter</span><span class="o">%</span><span class="n">plot_every</span><span class="o">==</span><span class="mi">0</span>

        <span class="k">if</span> <span class="n">plotting_time</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I plot.&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">n_sinkhorn_last</span> <span class="o">=</span> <span class="mi">250</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">n_sinkhorn</span> <span class="o">=</span> <span class="mi">250</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">s0</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;I do not plot.&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">n_sinkhorn_last</span> <span class="o">=</span> <span class="mi">250</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">n_sinkhorn</span> <span class="o">=</span> <span class="mi">250</span>
            <span class="n">solver</span><span class="o">.</span><span class="n">s0</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">simu</span><span class="o">.</span><span class="n">R_mean</span>

        <span class="n">R</span> <span class="o">=</span> <span class="p">(</span><span class="n">simu</span><span class="o">.</span><span class="n">volumes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">/</span><span class="mf">3.</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>

        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">F_inc</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">lloyd_step</span><span class="p">(</span><span class="n">simu</span><span class="p">,</span>
                <span class="n">sinkhorn_algo</span><span class="o">=</span><span class="n">ot_algo</span><span class="p">,</span><span class="n">cap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">tau</span><span class="o">=</span><span class="mf">42.0</span><span class="o">/</span><span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                <span class="n">to_bary</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">show_progress</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">default_init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">stopping_criterion</span><span class="o">=</span><span class="s2">&quot;average&quot;</span><span class="p">,</span>
                <span class="n">tol</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                <span class="n">bsr</span><span class="o">=</span><span class="n">bsr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solving incompressibility: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean incompressiblity force: </span><span class="si">{</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">F_inc</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">simu</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">v0</span><span class="o">*</span><span class="n">simu</span><span class="o">.</span><span class="n">axis</span><span class="o">*</span><span class="n">dt</span> <span class="o">+</span> <span class="n">F_inc</span><span class="o">*</span><span class="n">dt</span>

        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">simu</span><span class="o">.</span><span class="n">covariance_matrix</span><span class="p">(</span><span class="n">bsr</span><span class="o">=</span><span class="n">bsr</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing covariance matrix: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">stime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">cov</span> <span class="o">/=</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.</span><span class="o">/</span><span class="mf">3.</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">simu</span><span class="o">.</span><span class="n">N_cells</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">L</span><span class="p">,</span><span class="n">Q</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">L</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">L</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="mf">3.</span><span class="p">)</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="n">Q</span><span class="p">[:,:,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">axis</span> <span class="o">=</span> <span class="p">(</span><span class="n">axis</span> <span class="o">*</span> <span class="n">simu</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sign</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">simu</span><span class="o">.</span><span class="n">N_cells</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">axis</span>

        <span class="n">simu</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="n">axis</span>
        <span class="n">simu</span><span class="o">.</span><span class="n">ar</span> <span class="o">=</span> <span class="n">ar</span>

        <span class="n">simu</span><span class="o">.</span><span class="n">ar</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">min_ar</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">max_ar</span><span class="p">,</span><span class="n">simu</span><span class="o">.</span><span class="n">ar</span><span class="p">))</span>
        <span class="n">simu</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="n">simu</span><span class="o">.</span><span class="n">orientation_from_axis</span><span class="p">()</span>

        <span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="o">==</span><span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Update parameters: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plotting_time</span><span class="p">:</span>
            <span class="n">plot_cells</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span><span class="n">simu</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">,</span><span class="n">M</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;wireframe&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">remove_scalar_bar</span><span class="p">()</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="n">simu_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;/frames/t_</span><span class="si">{</span><span class="n">t_plot</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">)</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">clear_actors</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pos&quot;</span> <span class="p">:</span> <span class="n">simu</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                    <span class="s2">&quot;axis&quot;</span> <span class="p">:</span> <span class="n">simu</span><span class="o">.</span><span class="n">axis</span><span class="p">,</span>
                    <span class="s2">&quot;ar&quot;</span> <span class="p">:</span> <span class="n">simu</span><span class="o">.</span><span class="n">ar</span><span class="p">}</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">simu_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/data/data_</span><span class="si">{</span><span class="n">t_plot</span><span class="si">}</span><span class="s2">.pkl&quot;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>
            <span class="c1"># tif.imsave(simu_name + &quot;/frames/&quot;+f&quot;t_{t_plot}.tif&quot;, simu.labels.reshape(M,M,M).cpu().numpy(), bigtiff=True)</span>
            <span class="n">t_plot</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">t</span> <span class="o">+=</span> <span class="n">dt</span>
        <span class="n">t_iter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">simu_name</span> <span class="o">+</span> <span class="s2">&quot;/data/data_final.pkl&quot;</span><span class="p">,</span><span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">simu</span><span class="p">,</span><span class="n">file</span><span class="p">)</span>

    <span class="c1"># utils.make_video(simu_name=simu_name,video_name=simu_name)</span>



<span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<span class="n">benchmark</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">101</span><span class="p">,</span><span class="n">M</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span><span class="n">T</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">dt</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span><span class="n">plot_every</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">bsr</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--------------&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total computation time: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start_time</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">,</span><span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-auto-examples-benchmark-3d-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../_downloads/718a6fbe669397c8bce690a4760f1bdd/Benchmark_3D.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">Benchmark_3D.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../_downloads/6c97c7362739c1ec929a3cdd69a84243/Benchmark_3D.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">Benchmark_3D.py</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="ActiveBrownian.html" class="btn btn-neutral float-left" title="Active Brownian Particles" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ChemoDeformation.html" class="btn btn-neutral float-right" title="Chemotaxis induced by deformations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Antoine Diez, Jean Feydy.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>